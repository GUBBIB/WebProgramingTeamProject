name: Deploy Laravel + React to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: EC2 ì„œë²„ì— ë°°í¬
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Backup .env and Remove Old Project Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            if [ -f ~/WebProgramingTeamProject/back-end/.env ]; then
              echo "ğŸ“¦ .env íŒŒì¼ ë°±ì—…"
              cp ~/WebProgramingTeamProject/back-end/.env ~/.env
            fi

            echo "ğŸ§¹ ê¸°ì¡´ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ì‚­ì œ"
            rm -rf ~/WebProgramingTeamProject

      - name: Upload Laravel + React to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "."
          target: "~/WebProgramingTeamProject"  

      - name: Restore .env and Run Services
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            if [ -f ~/.env_backup ]; then
              echo "ğŸ”„ .env ë³µì›"
              mv ~/.env ~/WebProgramingTeamProject/back-end/.env
            fi

            cd ~/WebProgramingTeamProject/back-end
            composer install
            sudo chown -R www-data:www-data storage bootstrap/cache
            sudo chmod -R 775 storage bootstrap/cache

            echo "âš™ï¸ React í”„ë¡ íŠ¸ì—”ë“œ ë¹Œë“œ"
            cd ~/WebProgramingTeamProject/front-end
            npm install
            npm run build

            echo "ğŸ” Apache ì¬ì‹œì‘"
            sudo systemctl restart apache2

            echo "âœ… ë°°í¬ ì™„ë£Œ"
